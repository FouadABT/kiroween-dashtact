{
  "enabled": true,
  "name": "Prisma Database Sync Agent",
  "description": "Monitors Prisma schema changes and automatically syncs database models between backend and frontend with comprehensive testing and verification",
  "version": "2",
  "when": {
    "type": "fileEdited",
    "patterns": [
      "backend/prisma/schema.prisma",
      "frontend/src/types/*.ts",
      "backend/src/**/*.entity.ts",
      "backend/src/**/*.dto.ts",
      "frontend/src/lib/api.ts"
    ]
  },
  "then": {
    "type": "askAgent",
    "prompt": "A database schema or model file has been modified. Please analyze the changes and perform a SAFE, VERIFIED sync operation:\n\n## PHASE 1: ANALYSIS & SAFETY CHECK\n1. **Identify what changed** (which file was edited)\n2. **Read and compare** the modified file with related files\n3. **Check for potential breaking changes** before making any modifications\n4. **Create a backup plan** - note what needs to be reverted if sync fails\n\n## PHASE 2: BACKEND SYNC (if schema.prisma or backend files changed)\n1. **If backend/prisma/schema.prisma changed:**\n   - Generate a new Prisma migration with descriptive name\n   - Regenerate the Prisma client (run: npm run prisma:generate in backend)\n   - **UPDATE backend/prisma/seed.ts** if new models or enums were added/changed\n   - Verify the generated client compiles without errors\n   - Update any affected NestJS services/controllers\n   - Update backend DTOs to match new schema\n   - Create/update corresponding TypeScript types in frontend/src/types/\n   - Update API client methods in frontend/src/lib/api.ts if needed\n   - Add new controller endpoints if new models were created\n\n2. **If backend DTOs/entities changed:**\n   - Verify they align with current Prisma schema\n   - Update corresponding frontend TypeScript interfaces\n   - Update API client methods to handle new data structures\n\n## PHASE 3: FRONTEND SYNC (if frontend types changed)\n1. **If frontend/src/types/*.ts changed:**\n   - Compare with current Prisma schema models\n   - Identify mismatches or missing fields\n   - Update backend DTOs if there are discrepancies\n   - Suggest Prisma schema changes if frontend requires new fields\n   - Update API client methods to use correct types\n   - Update any components that use the changed types\n\n## PHASE 4: COMPREHENSIVE TESTING\n1. **Create/update backend unit tests:**\n   - Generate service tests (backend/src/[module]/[module]-[feature].service.spec.ts)\n   - Test CRUD operations for modified models\n   - Test new relationships and foreign keys\n   - Verify DTOs validate correctly\n   - Test database constraints\n   - Test error handling for invalid data\n   - Ensure all Prisma queries work with new schema\n\n2. **Create/update backend controller tests:**\n   - Generate controller tests (backend/src/[module]/[module]-[feature].controller.spec.ts)\n   - Test all HTTP endpoints (GET, POST, PATCH, DELETE)\n   - Test request validation\n   - Test response structure\n   - Test error responses\n\n3. **Create/update E2E tests:**\n   - Generate E2E tests (backend/test/[module]-[feature].e2e-spec.ts)\n   - Test full API workflows\n   - Test data persistence\n   - Test relationships between models\n   - Test filtering and pagination\n\n4. **Verify type consistency:**\n   - Compare Prisma models with frontend types\n   - Check that all required fields exist in both\n   - Verify optional fields match between backend and frontend\n   - Ensure enum/relation values are identical\n   - Validate date/timestamp field handling\n\n5. **Run verification checks:**\n   - Check TypeScript compilation in backend (no type errors)\n   - Check TypeScript compilation in frontend (no type errors)\n   - Verify Prisma client generates successfully\n   - Test that API endpoints return correctly typed data\n   - Verify seed file runs without errors\n\n## PHASE 5: COMPREHENSIVE REPORT\nProvide a detailed summary including:\n1. **What changed:** List all modified files and changes made\n2. **Sync actions taken:** Migrations, type updates, test creation, seed updates\n3. **Files created/modified:** Complete list with brief description\n4. **Test results:** Pass/fail status of all verification checks\n5. **Type consistency report:** Confirm frontend and backend types match\n6. **Breaking changes:** Any API or schema changes that affect existing code\n7. **Manual verification commands:** \n   - Commands to regenerate Prisma client\n   - Commands to run tests\n   - Commands to start servers\n   - Commands to verify database\n8. **Rollback instructions:** How to undo changes if issues arise\n9. **Next steps:** Any manual actions required by developer\n\n## SAFETY RULES\n- ⚠️ NEVER delete existing migrations\n- ⚠️ ALWAYS regenerate Prisma client after schema changes\n- ⚠️ ALWAYS update seed file when models change\n- ⚠️ ALWAYS verify types match before completing sync\n- ⚠️ CREATE comprehensive tests (unit + controller + e2e) before marking sync complete\n- ⚠️ CHECK for compilation errors after each change\n- ⚠️ STOP and report if any verification step fails\n- ⚠️ PRESERVE existing functionality - only add/update, don't break\n- ⚠️ USE minimal, focused changes to reduce confusion\n- ⚠️ VALIDATE that all models are consistent across stack\n- ⚠️ TEST that seed file runs successfully with new schema\n\n## TEST NAMING CONVENTIONS\n- Service tests: `[module]-[feature].service.spec.ts` (e.g., `users-roles.service.spec.ts`)\n- Controller tests: `[module]-[feature].controller.spec.ts` (e.g., `users-roles.controller.spec.ts`)\n- E2E tests: `[module]-[feature].e2e-spec.ts` (e.g., `users-roles.e2e-spec.ts`)\n\nFocus on maintaining type safety, data consistency, comprehensive test coverage, and system stability across the PostgreSQL database, NestJS backend, and Next.js frontend."
  }
}
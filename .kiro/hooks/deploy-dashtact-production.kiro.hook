{
  "enabled": true,
  "name": "Deploy Dashtact to Production old",
  "description": "Comprehensive deployment workflow for the full-stack Dashtact application to AWS EC2 server. Handles file transfer via SCP, backend deployment with database migrations, frontend build and deployment, PM2 process management, and service verification. Includes pre-deployment checks, environment configuration, and post-deployment validation.",
  "version": "1",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "I need you to deploy the Dashtact full-stack application to production on AWS EC2.\n\n**IMPORTANT DEPLOYMENT CONTEXT:**\n- Server: AWS EC2 (13.53.218.109) in EU North 1\n- Domain: kit.dashtact.com (via Cloudflare)\n- SSH Key: C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\n- User: ubuntu\n- App Directory: /home/ubuntu/apps/kit-dashtact/\n- Backend Port: 3101 (NestJS)\n- Frontend Port: 3100 (Next.js)\n- Database: PostgreSQL (kit_dashtact_db)\n- Process Manager: PM2\n- Reverse Proxy: Nginx\n\n**DEPLOYMENT WORKFLOW:**\n\n1. **Pre-Deployment Checks:**\n   - Verify all environment files exist (.env.production for both backend/frontend)\n   - Check SSH key exists and has correct permissions\n   - Verify local builds compile successfully\n   - Confirm database connection string is correct\n   - Check that all dependencies are listed in package.json\n\n2. **File Transfer (SCP):**\n   - Copy backend/ directory to server: ~/apps/kit-dashtact/backend/\n   - Copy frontend/ directory to server: ~/apps/kit-dashtact/frontend/\n   - Exclude: node_modules/, .next/, dist/, .git/\n   - Use command: `scp -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" -r [source] ubuntu@13.53.218.109:[destination]`\n\n3. **Backend Deployment:**\n   ```bash\n   cd ~/apps/kit-dashtact/backend\n   \n   # Environment setup\n   cp .env.production .env\n   \n   # Install dependencies\n   npm install --production\n   \n   # Prisma setup\n   npm run prisma:generate\n   npm run prisma:migrate deploy\n   \n   # Build application\n   npm run build\n   \n   # PM2 process management\n   pm2 delete kit-backend 2>/dev/null || true\n   pm2 start dist/main.js --name kit-backend --env production\n   pm2 save\n   \n   # Verify\n   pm2 logs kit-backend --lines 20\n   curl http://localhost:3101/api/health\n   ```\n\n4. **Frontend Deployment:**\n   ```bash\n   cd ~/apps/kit-dashtact/frontend\n   \n   # Environment setup\n   cp .env.production .env.local\n   \n   # Install dependencies\n   npm install --production\n   \n   # Build application\n   npm run build\n   \n   # PM2 process management\n   pm2 delete kit-frontend 2>/dev/null || true\n   pm2 start npm --name kit-frontend -- start\n   pm2 save\n   \n   # Verify\n   pm2 logs kit-frontend --lines 20\n   curl -I http://localhost:3100\n   ```\n\n5. **Service Verification:**\n   ```bash\n   # Check all services\n   pm2 list\n   sudo systemctl status nginx\n   sudo systemctl status postgresql\n   \n   # Test endpoints\n   curl http://localhost:3101/api/health\n   curl -I http://localhost:3100\n   \n   # Check Nginx config\n   sudo nginx -t\n   ```\n\n6. **Post-Deployment Validation:**\n   - Visit https://kit.dashtact.com\n   - Test login functionality\n   - Verify API responses\n   - Check browser console for errors\n   - Monitor PM2 logs for issues\n\n**ENVIRONMENT VARIABLES TO VERIFY:**\n\nBackend (.env.production):\n- DATABASE_URL=postgresql://kit_dashtact_user:UcbMjpOJEbocT32GqNS20SYHSTr59JiS@localhost:5432/kit_dashtact_db?schema=public\n- PORT=3101\n- NODE_ENV=production\n- JWT_SECRET=7KmN9pQrS2tUvW3xY4zA6bC8dE1fG5hJ\n- CORS_ORIGIN=https://kit.dashtact.com\n\nFrontend (.env.production):\n- NEXT_PUBLIC_API_URL=https://kit.dashtact.com/api\n- NEXT_PUBLIC_APP_URL=https://kit.dashtact.com\n- NODE_ENV=production\n\n**SAFETY CHECKS:**\n- ⚠️ Always backup database before migrations: `pg_dump -U kit_dashtact_user -d kit_dashtact_db > backup_$(date +%Y%m%d).sql`\n- ⚠️ Test SSH connection before file transfer\n- ⚠️ Verify PM2 processes are running after restart\n- ⚠️ Check Nginx logs if site not accessible: `sudo tail -f /var/log/nginx/kit.dashtact.com.error.log`\n- ⚠️ Monitor application logs: `pm2 logs --lines 100`\n\n**ROLLBACK PROCEDURE:**\nIf deployment fails:\n1. Restore previous PM2 processes: `pm2 resurrect`\n2. Restore database backup: `psql -U kit_dashtact_user -d kit_dashtact_db < backup_[date].sql`\n3. Check logs for errors: `pm2 logs`\n4. Restart services: `pm2 restart all && sudo systemctl reload nginx`\n\n**OUTPUT REQUIREMENTS:**\nProvide a comprehensive deployment report including:\n1. Pre-deployment check results\n2. File transfer confirmation\n3. Backend deployment status (build, migrations, PM2)\n4. Frontend deployment status (build, PM2)\n5. Service verification results\n6. Post-deployment test results\n7. Any warnings or errors encountered\n8. Next steps or manual verification needed\n\nExecute the full deployment workflow now."
  }
}
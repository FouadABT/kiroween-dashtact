{
  "enabled": true,
  "name": "Deploy Dashtact to Production",
  "description": "Comprehensive deployment workflow for Dashtact full-stack application to AWS EC2. Handles initial deployment and updates, performs pre-deployment checks, transfers files via SCP, deploys backend (NestJS) and frontend (Next.js), manages PM2 processes, verifies services, and creates detailed deployment logs. Includes safety checks, rollback procedures, and ensures production config matches development standards.",
  "version": "1",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "I need you to deploy the Dashtact full-stack application to production on AWS EC2.\n\n**DEPLOYMENT CONTEXT:**\n- Server: AWS EC2 (13.53.218.109) in EU North 1\n- Domain: kit.dashtact.com (via Cloudflare)\n- SSH Key: C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\n- User: ubuntu\n- App Directory: /home/ubuntu/apps/kit-dashtact/\n- Backend Port: 3101 (NestJS)\n- Frontend Port: 3100 (Next.js)\n- Database: PostgreSQL (kit_dashtact_db)\n- Process Manager: PM2\n- Reverse Proxy: Nginx\n\n**CRITICAL REQUIREMENTS:**\n\n1. **Check Deployment Status First:**\n   - SSH into server and check if /home/ubuntu/apps/kit-dashtact/ exists\n   - Check if deployment.log exists in the app directory\n   - Read deployment.log to determine if this is initial deployment or update\n   - If directory doesn't exist: This is INITIAL DEPLOYMENT\n   - If directory exists: This is UPDATE/REDEPLOY\n\n2. **Deployment Log Management:**\n   - Create/append to /home/ubuntu/apps/kit-dashtact/deployment.log\n   - Log format: [TIMESTAMP] [TYPE: INITIAL|UPDATE] [STATUS] Message\n   - Include: deployment type, files changed, services restarted, errors, duration\n   - Each deployment should append to log with clear separation\n   - Log should persist across deployments for history tracking\n\n3. **Configuration Consistency:**\n   - Verify frontend dev config (tailwind.config.js, postcss.config.js, next.config.ts)\n   - Ensure production uses SAME configuration as development\n   - Copy exact config files from local to production\n   - Validate no config drift between environments\n\n**DEPLOYMENT WORKFLOW:**\n\n**Phase 1: Pre-Deployment Checks**\n- Test SSH connection: `ssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109 \"echo 'Connection successful'\"`\n- Check if app directory exists on server\n- Read deployment.log if exists to understand deployment history\n- Verify environment files exist locally:\n  - backend/.env.production\n  - frontend/.env.production\n- Verify local builds compile:\n  - `cd backend && npm run build`\n  - `cd frontend && npm run build`\n- Backup database: `ssh ... \"pg_dump -U kit_dashtact_user -d kit_dashtact_db > /home/ubuntu/backups/backup_$(date +%Y%m%d_%H%M%S).sql\"`\n\n**Phase 2: Determine Deployment Type**\n```bash\n# SSH command to check status\nssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109 '\n  if [ -d \"/home/ubuntu/apps/kit-dashtact\" ]; then\n    echo \"EXISTING_DEPLOYMENT\"\n    if [ -f \"/home/ubuntu/apps/kit-dashtact/deployment.log\" ]; then\n      echo \"=== Last 10 Deployments ===\"\n      tail -n 50 /home/ubuntu/apps/kit-dashtact/deployment.log\n    fi\n  else\n    echo \"INITIAL_DEPLOYMENT\"\n    mkdir -p /home/ubuntu/apps/kit-dashtact\n  fi\n'\n```\n\n**Phase 3: File Transfer (SCP)**\n- Create temporary staging directory on server if needed\n- Transfer backend (exclude: node_modules/, dist/, .git/):\n  ```powershell\n  scp -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" -r backend/ ubuntu@13.53.218.109:/home/ubuntu/apps/kit-dashtact/backend/\n  ```\n- Transfer frontend (exclude: node_modules/, .next/, .git/):\n  ```powershell\n  scp -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" -r frontend/ ubuntu@13.53.218.109:/home/ubuntu/apps/kit-dashtact/frontend/\n  ```\n- Verify file transfer completed successfully\n\n**Phase 4: Backend Deployment**\n```bash\nssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109 '\n  cd /home/ubuntu/apps/kit-dashtact/backend\n  \n  # Log deployment start\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [BACKEND] Starting backend deployment...\" >> ../deployment.log\n  \n  # Environment setup\n  cp .env.production .env\n  \n  # Install dependencies\n  npm install --production\n  \n  # Prisma setup\n  npm run prisma:generate\n  npm run prisma:migrate deploy\n  \n  # Build application\n  npm run build\n  \n  # PM2 process management\n  if pm2 describe kit-backend > /dev/null 2>&1; then\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [BACKEND] Restarting existing PM2 process...\" >> ../deployment.log\n    pm2 restart kit-backend\n  else\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [BACKEND] Creating new PM2 process...\" >> ../deployment.log\n    pm2 start dist/main.js --name kit-backend --env production\n  fi\n  pm2 save\n  \n  # Verify\n  sleep 3\n  if curl -f http://localhost:3101/api/health > /dev/null 2>&1; then\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [BACKEND] ✅ Backend health check passed\" >> ../deployment.log\n  else\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [BACKEND] ❌ Backend health check failed\" >> ../deployment.log\n  fi\n'\n```\n\n**Phase 5: Frontend Deployment**\n```bash\nssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109 '\n  cd /home/ubuntu/apps/kit-dashtact/frontend\n  \n  # Log deployment start\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Starting frontend deployment...\" >> ../deployment.log\n  \n  # Environment setup\n  cp .env.production .env.local\n  \n  # Verify config files match development\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Config files present:\" >> ../deployment.log\n  ls -la tailwind.config.js postcss.config.js next.config.ts >> ../deployment.log 2>&1\n  \n  # Install dependencies\n  npm install --production\n  \n  # Build application\n  npm run build\n  \n  # PM2 process management\n  if pm2 describe kit-frontend > /dev/null 2>&1; then\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Restarting existing PM2 process...\" >> ../deployment.log\n    pm2 restart kit-frontend\n  else\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Creating new PM2 process...\" >> ../deployment.log\n    pm2 start npm --name kit-frontend -- start\n  fi\n  pm2 save\n  \n  # Verify\n  sleep 3\n  if curl -f -I http://localhost:3100 > /dev/null 2>&1; then\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] ✅ Frontend health check passed\" >> ../deployment.log\n  else\n    echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] ❌ Frontend health check failed\" >> ../deployment.log\n  fi\n'\n```\n\n**Phase 6: Service Verification**\n```bash\nssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109 '\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [VERIFY] Running service verification...\" >> /home/ubuntu/apps/kit-dashtact/deployment.log\n  \n  # Check PM2 processes\n  pm2 list | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  \n  # Check Nginx\n  sudo systemctl status nginx --no-pager | head -n 5 | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  \n  # Check PostgreSQL\n  sudo systemctl status postgresql --no-pager | head -n 5 | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  \n  # Test endpoints\n  echo \"Testing backend API...\" | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  curl -s http://localhost:3101/api/health | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  \n  echo \"Testing frontend...\" | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  curl -s -I http://localhost:3100 | head -n 1 | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n  \n  # Nginx config test\n  sudo nginx -t 2>&1 | tee -a /home/ubuntu/apps/kit-dashtact/deployment.log\n'\n```\n\n**Phase 7: Post-Deployment Validation**\n- Visit https://kit.dashtact.com and verify site loads\n- Test login functionality\n- Check browser console for errors\n- Monitor PM2 logs: `pm2 logs --lines 50`\n- Check Nginx logs if issues: `sudo tail -f /var/log/nginx/kit.dashtact.com.error.log`\n\n**Phase 8: Finalize Deployment Log**\n```bash\nssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109 '\n  cd /home/ubuntu/apps/kit-dashtact\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [COMPLETE] ========================================\" >> deployment.log\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [COMPLETE] Deployment finished successfully\" >> deployment.log\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [COMPLETE] ========================================\" >> deployment.log\n  echo \"\" >> deployment.log\n'\n```\n\n**ENVIRONMENT VARIABLES TO VERIFY:**\n\nBackend (.env.production):\n```env\nDATABASE_URL=postgresql://kit_dashtact_user:UcbMjpOJEbocT32GqNS20SYHSTr59JiS@localhost:5432/kit_dashtact_db?schema=public\nPORT=3101\nNODE_ENV=production\nJWT_SECRET=7KmN9pQrS2tUvW3xY4zA6bC8dE1fG5hJ\nCORS_ORIGIN=https://kit.dashtact.com\n```\n\nFrontend (.env.production):\n```env\nNEXT_PUBLIC_API_URL=https://kit.dashtact.com/api\nNEXT_PUBLIC_APP_URL=https://kit.dashtact.com\nNODE_ENV=production\n```\n\n**SAFETY CHECKS:**\n- ⚠️ Always backup database before migrations\n- ⚠️ Test SSH connection before file transfer\n- ⚠️ Verify PM2 processes running after restart\n- ⚠️ Check Nginx logs if site not accessible\n- ⚠️ Monitor application logs during deployment\n- ⚠️ Verify config files match between dev and prod\n- ⚠️ Keep deployment log for audit trail\n\n**ROLLBACK PROCEDURE:**\nIf deployment fails:\n1. Check deployment.log for error details\n2. Restore database: `psql -U kit_dashtact_user -d kit_dashtact_db < /home/ubuntu/backups/backup_[timestamp].sql`\n3. Restart services: `pm2 restart all && sudo systemctl reload nginx`\n4. Check logs: `pm2 logs --lines 100`\n5. Document failure in deployment.log\n\n**OUTPUT REQUIREMENTS:**\nProvide a comprehensive deployment report including:\n1. Deployment type (initial or update)\n2. Pre-deployment check results\n3. File transfer confirmation with file counts\n4. Backend deployment status (build, migrations, PM2)\n5. Frontend deployment status (build, config verification, PM2)\n6. Service verification results (PM2, Nginx, PostgreSQL)\n7. Post-deployment test results (site access, API health)\n8. Deployment log summary (last 20 lines)\n9. Any warnings or errors encountered\n10. Next steps or manual verification needed\n11. Rollback instructions if needed\n\nExecute the full deployment workflow now."
  }
}
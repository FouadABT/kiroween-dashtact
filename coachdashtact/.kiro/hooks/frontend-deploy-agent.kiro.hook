{
  "enabled": true,
  "name": "Frontend Deployment Agent",
  "description": "Automatically deploys frontend to AWS EC2 production server when frontend files change. Builds locally with production env, zips, transfers via SCP, and deploys with zero-downtime restart.",
  "version": "1",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "Frontend files have changed. Execute the following deployment workflow:\n\n**DEPLOYMENT TYPE**: Frontend Only - Fast Deploy\n\n**PRE-DEPLOYMENT CHECKS**:\n1. Test SSH connection to 13.53.218.109\n2. Check if /home/ubuntu/apps/kit-dashtact/ exists on server\n3. Read deployment.log if exists to understand deployment history\n4. Backup current frontend directory on server\n\n**LOCAL BUILD PROCESS**:\n1. Navigate to frontend/ directory\n2. Copy .env.production to .env.local\n3. Verify config files present: tailwind.config.js, postcss.config.mjs, next.config.ts\n4. Run: npm install --production\n5. Run: npm run build (using production env)\n6. Verify .next/ directory created successfully\n7. Create deployment package:\n   - Include: .next/, public/, package.json, package-lock.json, next.config.ts\n   - Exclude: node_modules/, src/, .git/\n8. Zip the package: frontend-deploy-[timestamp].zip\n\n**SERVER PREPARATION**:\nSSH Command: `ssh -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" ubuntu@13.53.218.109`\n\nExecute on server:\n```bash\n# Log deployment start\necho \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Starting fast frontend deployment...\" >> /home/ubuntu/apps/kit-dashtact/deployment.log\n\n# Stop frontend PM2 process\npm2 stop kit-frontend\n\n# Backup current frontend\nif [ -d \"/home/ubuntu/apps/kit-dashtact/frontend\" ]; then\n  mv /home/ubuntu/apps/kit-dashtact/frontend /home/ubuntu/apps/kit-dashtact/frontend.backup.$(date +%Y%m%d_%H%M%S)\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Backed up existing frontend\" >> /home/ubuntu/apps/kit-dashtact/deployment.log\nfi\n\n# Create fresh frontend directory\nmkdir -p /home/ubuntu/apps/kit-dashtact/frontend\n```\n\n**FILE TRANSFER**:\nPowerShell Command:\n```powershell\nscp -i \"C:\\Users\\fabat\\Desktop\\dashtact\\my-ec2-key.pem\" frontend-deploy-[timestamp].zip ubuntu@13.53.218.109:/home/ubuntu/apps/kit-dashtact/frontend/\n```\n\n**SERVER DEPLOYMENT**:\n```bash\ncd /home/ubuntu/apps/kit-dashtact/frontend\n\n# Unzip deployment package\nunzip -q frontend-deploy-[timestamp].zip\nrm frontend-deploy-[timestamp].zip\n\n# Copy production environment\ncp .env.production .env.local\n\n# Log config verification\necho \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Config files:\" >> ../deployment.log\nls -la tailwind.config.js postcss.config.mjs next.config.ts >> ../deployment.log 2>&1\n\n# Install production dependencies only\nnpm install --production --no-optional\n\n# Restart PM2 process\npm2 restart kit-frontend || pm2 start npm --name kit-frontend -- start\npm2 save\n\n# Health check\nsleep 3\nif curl -f -I http://localhost:3100 > /dev/null 2>&1; then\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] ✅ Frontend deployed successfully\" >> ../deployment.log\nelse\n  echo \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] ❌ Frontend health check failed\" >> ../deployment.log\n  # Rollback\n  pm2 stop kit-frontend\n  rm -rf /home/ubuntu/apps/kit-dashtact/frontend\n  mv /home/ubuntu/apps/kit-dashtact/frontend.backup.* /home/ubuntu/apps/kit-dashtact/frontend\n  pm2 start kit-frontend\nfi\n\n# Cleanup old backups (keep last 3)\nls -dt /home/ubuntu/apps/kit-dashtact/frontend.backup.* | tail -n +4 | xargs rm -rf\n\necho \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] Deployment complete\" >> ../deployment.log\n```\n\n**POST-DEPLOYMENT VERIFICATION**:\n1. Check PM2 status: `pm2 list`\n2. Test frontend: `curl -I http://localhost:3100`\n3. Test public URL: https://kit.dashtact.com\n4. Check PM2 logs: `pm2 logs kit-frontend --lines 20`\n5. Verify no console errors in browser\n6. Test key functionality (login, navigation)\n\n**DEPLOYMENT REPORT**:\nProvide comprehensive report including:\n- Deployment timestamp\n- Files changed that triggered deployment\n- Build status and duration\n- Transfer confirmation\n- PM2 restart status\n- Health check results\n- Last 10 lines of deployment.log\n- Any warnings or errors\n- Rollback status if failed\n\n**ROLLBACK PROCEDURE** (if deployment fails):\n```bash\npm2 stop kit-frontend\nrm -rf /home/ubuntu/apps/kit-dashtact/frontend\nmv /home/ubuntu/apps/kit-dashtact/frontend.backup.[latest] /home/ubuntu/apps/kit-dashtact/frontend\npm2 start kit-frontend\necho \"[$(date +\"%Y-%m-%d %H:%M:%S\")] [FRONTEND] ❌ Rolled back to previous version\" >> /home/ubuntu/apps/kit-dashtact/deployment.log\n```\n\n**SAFETY CHECKS**:\n- ⚠️ Always backup before deployment\n- ⚠️ Verify build completes successfully locally\n- ⚠️ Test SSH connection before transfer\n- ⚠️ Stop PM2 process before replacing files\n- ⚠️ Run health check after restart\n- ⚠️ Keep deployment log updated\n- ⚠️ Automatic rollback on failure\n\nExecute this deployment workflow now and provide detailed status report."
  }
}
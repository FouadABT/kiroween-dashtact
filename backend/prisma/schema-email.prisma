// Email System Models - Add these to the main schema.prisma file

model EmailConfiguration {
  id          String   @id @default(cuid())
  smtpHost    String   @map("smtp_host")
  smtpPort    Int      @map("smtp_port")
  smtpSecure  Boolean  @default(true) @map("smtp_secure")
  smtpUsername String  @map("smtp_username")
  smtpPassword String  @map("smtp_password") // Encrypted
  senderEmail String   @map("sender_email")
  senderName  String   @map("sender_name")
  isEnabled   Boolean  @default(false) @map("is_enabled")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by")
  updatedBy   String   @map("updated_by")

  @@map("email_configuration")
}

model EmailTemplate {
  id          String     @id @default(cuid())
  name        String     @unique
  slug        String     @unique
  subject     String
  htmlBody    String     @db.Text @map("html_body")
  textBody    String?    @db.Text @map("text_body")
  variables   Json
  category    String     @default("SYSTEM")
  isActive    Boolean    @default(true) @map("is_active")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  createdBy   String     @map("created_by")
  updatedBy   String     @map("updated_by")
  emailLogs   EmailLog[]

  @@index([slug])
  @@index([category])
  @@map("email_templates")
}

model EmailQueue {
  id             String           @id @default(cuid())
  recipient      String
  subject        String
  htmlBody       String?          @db.Text @map("html_body")
  textBody       String?          @db.Text @map("text_body")
  templateId     String?          @map("template_id")
  templateData   Json?            @map("template_data")
  status         EmailQueueStatus @default(PENDING)
  priority       Int              @default(5)
  attempts       Int              @default(0)
  maxAttempts    Int              @default(3) @map("max_attempts")
  lastAttemptAt  DateTime?        @map("last_attempt_at")
  nextAttemptAt  DateTime?        @map("next_attempt_at")
  error          String?          @db.Text
  metadata       Json?
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  @@index([status, nextAttemptAt])
  @@index([createdAt])
  @@index([priority])
  @@map("email_queue")
}

model EmailLog {
  id         String        @id @default(cuid())
  recipient  String
  subject    String
  templateId String?       @map("template_id")
  template   EmailTemplate? @relation(fields: [templateId], references: [id])
  status     EmailStatus
  sentAt     DateTime?     @map("sent_at")
  error      String?       @db.Text
  metadata   Json?
  userId     String?       @map("user_id")
  createdAt  DateTime      @default(now()) @map("created_at")

  @@index([recipient])
  @@index([status])
  @@index([createdAt])
  @@index([userId])
  @@map("email_logs")
}

model EmailRateLimit {
  id            String   @id @default(cuid())
  windowType    String   @map("window_type") // 'hourly' or 'daily'
  windowStart   DateTime @map("window_start")
  emailCount    Int      @default(0) @map("email_count")
  maxEmails     Int      @map("max_emails")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([windowType, windowStart])
  @@index([windowStart])
  @@map("email_rate_limits")
}

enum EmailQueueStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
  CANCELLED
}

enum EmailStatus {
  SENT
  FAILED
  BOUNCED
  SKIPPED
}
